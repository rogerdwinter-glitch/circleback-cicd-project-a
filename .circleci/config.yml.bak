version: 2.1

orbs:
  node: circleci/node@4.7.0

jobs:
  build-and-test:
    parameters:
      node-version:
        type: string
        default: "15.10.0"
    docker:
      - image: cimg/node:<< parameters.node-version >>
    parallelism: 4
    steps:
      - checkout
      - node/install-packages
      - run:
          command: |
            npm run test-ci
    
  trigger-project-b-pipeline:
    docker: 
      - image: cimg/base:stable
    resource_class: small
    steps:
      - run:
          name: Ping another pipeline
          command: |
            echo "Attempting to trigger pipeline B..."
            echo "API Key present: Yes"
            
            # Make the API call and capture the full response
            RESPONSE={
  "message" : "Project not found"
}
            
            echo "API Response:"
            echo ""
            
            # Try to extract the ID
            CREATED_PIPELINE="null"
            
            # Check if we got an error message instead
            ERROR_MESSAGE="null"
            
            if [ "" != "null" ]; then
              echo "Error from API: "
              echo "This likely means the project is not found or not accessible via GitHub provider"
              echo "Trying alternative approaches..."
              
              # Try without /pipeline endpoint
              echo "Attempting without /pipeline endpoint..."
              RESPONSE2={
  "message" : "Not Found"
}
              echo "Alternative response: "
              
              exit 1
            fi
            
            if [ "" = "null" ] || [ -z "" ]; then
              echo "Failed to get pipeline ID from response"
              exit 1
            fi
            
            echo "Successfully created pipeline: "
            mkdir ~/workspace
            echo  > ~/workspace/pipeline.txt
      - persist_to_workspace:
          root: ~/workspace
          paths: 
            - pipeline.txt  

  check-status-of-triggered-pipeline:
    docker: 
      - image: cimg/base:stable
    resource_class: small 
    steps:
      - attach_workspace:
          at: ~/workspace
      - run:
          name: Check triggered workflow status
          command: |
            triggered_pipeline_id=

            created_workflow_status=

            echo 

            if [[ "" != "success" ]]; then
              echo "Workflow not successful - "
              (exit -1) 
            fi
            
            echo "Created workflow successful"


workflows:
  node-test-and-deploy:
    jobs:
      - build-and-test
      - trigger-project-b-pipeline:
          context: 
            - circleci-api
          requires:
            - build-and-test
          filters:
            branches:
              only: main
      - wait-for-triggered-pipeline:
          type: approval
          requires: 
            - trigger-project-b-pipeline
      - check-status-of-triggered-pipeline:
          requires:
            - wait-for-triggered-pipeline
          context:
            - circleci-api
